<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MTG Card Scanner → Scryfall (Hardened Lookup)</title>
  <style>
    body { font-family: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 16px; line-height: 1.45; }
    header { margin-bottom: 12px; }
    video, canvas { width: 100%; max-width: 640px; border: 1px solid #ddd; border-radius: 8px; }
    .row { display: flex; flex-wrap: wrap; gap: 16px; }
    .col { flex: 1 1 320px; min-width: 300px; }
    button { padding: 10px 14px; border-radius: 8px; border: 1px solid #ccc; background: #f7f7f7; font-size: 16px; }
    button:disabled { opacity: 0.5; }
    #status { font-size: 14px; opacity: 0.9; display:inline-block; margin-top:8px; }
    #result img { max-width: 100%; border-radius: 8px; border: 1px solid #ddd; }
    #ocrText { white-space: pre-wrap; background: #fafafa; border: 1px solid #eee; padding: 8px; border-radius: 6px; }
    .small { font-size: 12px; color: #666; }
    .warn { color: #b00020; }
    .ok { color: #0a7f11; }
    .block { display:block; }
    .meta p { margin: 6px 0; }
    .badge { font-size: 12px; padding: 2px 6px; border: 1px solid #ddd; border-radius: 999px; }
    .flex { display:flex; gap:8px; flex-wrap: wrap; align-items:center; }
    input[type="text"]{ padding:8px; border:1px solid #ccc; border-radius:6px; min-width:260px; }
    ul.suggestions{ list-style: none; padding-left: 0; }
    ul.suggestions li{ margin: 4px 0; }
    ul.suggestions button{ font-size:14px; }
  </style>
</head>
<body>
  <header>
    <h1>MTG Card Scanner → Scryfall</h1>
    <p>Now better at foreign names: cleans OCR, searches multilingual, and offers suggestions.</p>
  </header>

  <div class="row">
    <div class="col">
      <video id="video" playsinline muted></video>
      <div style="margin-top:8px;">
        <button id="startBtn">Start Camera</button>
        <button id="scanBtn" disabled>Scan &amp; Lookup</button>
        <button id="swapBtn" disabled>Swap Camera</button>
      </div>
      <span id="status" class="block"></span>
      <canvas id="canvas" hidden></canvas>
      <p class="small">Tip: Aim at the name line. Good light helps OCR.</p>
    </div>

    <div class="col">
      <h3>Result</h3>
      <div class="flex" style="margin-bottom:8px;">
        <label for="guessInput" style="font-size:14px;">Detected name:</label>
        <input id="guessInput" type="text" placeholder="(will appear after scan)" />
        <button id="lookupBtn" disabled>Lookup</button>
      </div>
      <div id="result"></div>
      <div id="actions" style="margin-top:8px;"></div>
      <details style="margin-top:8px;">
        <summary>Show OCR text</summary>
        <pre id="ocrText"></pre>
      </details>
      <div id="alts" style="margin-top:12px;"></div>
    </div>
  </div>

  <script>
    var video = document.getElementById('video');
    var canvas = document.getElementById('canvas');
    var startBtn = document.getElementById('startBtn');
    var scanBtn = document.getElementById('scanBtn');
    var swapBtn = document.getElementById('swapBtn');
    var statusEl = document.getElementById('status');
    var resultEl = document.getElementById('result');
    var actionsEl = document.getElementById('actions');
    var ocrTextEl = document.getElementById('ocrText');
    var guessInput = document.getElementById('guessInput');
    var lookupBtn = document.getElementById('lookupBtn');
    var altsEl = document.getElementById('alts');

    var currentStream = null;
    var usingBackCamera = true;
    var Tesseract = null;

    function logStatus(msg, ok){
      statusEl.textContent = msg;
      statusEl.className = (ok ? 'ok' : 'warn') + ' block';
    }

    function isSecureAllowed() {
      var loc = window.location;
      return loc.protocol === 'https:' || loc.hostname === 'localhost' || loc.hostname === '127.0.0.1';
    }

    function startCamera(){
      if (!isSecureAllowed()) {
        logStatus('Camera requires HTTPS or localhost. Make sure the URL starts with https://', false);
        return;
      }
      if (!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia)) {
        logStatus('This browser does not support camera access (getUserMedia).', false);
        return;
      }
      var constraints = { audio:false, video:{ facingMode:{ ideal: usingBackCamera ? 'environment' : 'user' } } };
      navigator.mediaDevices.getUserMedia(constraints).then(function(stream){
        currentStream = stream;
        video.srcObject = stream;
        return video.play();
      }).then(function(){
        scanBtn.disabled = false;
        swapBtn.disabled = false;
        logStatus('Camera started.', true);
      }).catch(function(e1){
        navigator.mediaDevices.getUserMedia({ video:true, audio:false }).then(function(stream){
          currentStream = stream;
          video.srcObject = stream;
          return video.play();
        }).then(function(){
          scanBtn.disabled = false;
          swapBtn.disabled = false;
          logStatus('Camera started (fallback).', true);
        }).catch(function(e2){
          logStatus('Camera error: ' + (e2 && e2.message ? e2.message : e2), false);
        });
      });
    }

    function stopCamera(){
      if (currentStream){
        var tracks = currentStream.getTracks();
        for (var i=0; i<tracks.length; i++) tracks[i].stop();
      }
      currentStream = null;
      scanBtn.disabled = true;
      swapBtn.disabled = true;
      logStatus('Camera stopped.', false);
    }

    startBtn.addEventListener('click', function(){
      if (currentStream) stopCamera(); else startCamera();
    });

    swapBtn.addEventListener('click', function(){
      if (!currentStream) return;
      stopCamera();
      usingBackCamera = !usingBackCamera;
      startCamera();
    });

    function firstTextLine(raw){
      var lines = (raw || '').split(/[\r\n]+/);
      for (var i=0; i<lines.length; i++){
        var l = (lines[i] || '').trim();
        if (!l) continue;
        // Ignore lines that are mostly numbers/symbols
        var letters = l.replace(/[^A-Za-zÀ-ÖØ-öø-ÿ'\-’ ]/g, '');
        if (letters.replace(/\s+/g,'').length >= Math.max(3, Math.floor(l.length*0.6))){
          return l;
        }
      }
      return (lines[0] || '').trim();
    }

    function sanitizeName(s){
      // Keep only letters, spaces, apostrophes, dashes, collapse spaces
      return (s || '')
        .replace(/[_~`^\\|]/g,' ')
        .replace(/[0-9]+/g,' ')
        .replace(/[^A-Za-zÀ-ÖØ-öø-ÿ'\-’ ]/g, ' ')
        .replace(/\s+/g,' ')
        .trim();
    }

    function loadTesseract(){
      if (Tesseract) return Promise.resolve(Tesseract);
      return new Promise(function(resolve, reject){
        var s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js';
        s.onload = function(){ Tesseract = window.Tesseract; resolve(Tesseract); };
        s.onerror = function(){ reject(new Error('Failed to load Tesseract.js')); };
        document.head.appendChild(s);
      });
    }

    function scryfallNamedFuzzy(name){
      return fetch('https://api.scryfall.com/cards/named?fuzzy=' + encodeURIComponent(name))
        .then(function(res){ if(!res.ok) throw new Error('named?fuzzy ' + res.status); return res.json(); });
    }

    function scryfallSearchLangAnyExactPhrase(name){
      var q = 'lang:any "' + name + '"';
      var url = 'https://api.scryfall.com/cards/search?q=' + encodeURIComponent(q) + '&include_multilingual=true&unique=prints';
      return fetch(url).then(function(res){ if(!res.ok) throw new Error('search lang:any ' + res.status); return res.json(); })
        .then(function(list){ if (list && list.data && list.data.length) return list.data[0]; throw new Error('no results (lang:any)'); });
    }

    function scryfallSearchFrenchExactPhrase(name){
      var q = 'lang:fr "' + name + '"';
      var url = 'https://api.scryfall.com/cards/search?q=' + encodeURIComponent(q) + '&include_multilingual=true&unique=prints';
      return fetch(url).then(function(res){ if(!res.ok) throw new Error('search lang:fr ' + res.status); return res.json(); })
        .then(function(list){ if (list && list.data && list.data.length) return list.data[0]; throw new Error('no results (lang:fr)'); });
    }

    function scryfallAutocomplete(name){
      var url = 'https://api.scryfall.com/cards/autocomplete?q=' + encodeURIComponent(name);
      return fetch(url).then(function(res){ if(!res.ok) throw new Error('autocomplete ' + res.status); return res.json(); });
    }

    function renderCard(card){
      resultEl.innerHTML = '';
      actionsEl.innerHTML = '';
      altsEl.innerHTML = '';

      var img = null;
      if (card.image_uris && card.image_uris.normal) img = card.image_uris.normal;
      else if (card.card_faces && card.card_faces[0] && card.card_faces[0].image_uris) img = card.card_faces[0].image_uris.normal;

      var container = document.createElement('div');
      if (img){
        var image = document.createElement('img');
        image.src = img;
        image.alt = card.name;
        container.appendChild(image);
      }

      var printed = card.printed_name ? (' / ' + card.printed_name) : '';
      var langBadge = '<span class="badge">Lang: ' + (card.lang || 'en') + '</span>';
      var oracle = (card.oracle_text || '').replace(/\n/g, '<br>');
      var meta = document.createElement('div');
      meta.className = 'meta';
      meta.innerHTML = '<p><strong>' + card.name + printed + '</strong> ' + langBadge + '</p>' +
                       '<p>' + (card.type_line || '') + '</p>' +
                       '<p><em>Oracle (English)</em><br>' + oracle + '</p>';
      container.appendChild(meta);
      resultEl.appendChild(container);

      var openEnglish = document.createElement('button');
      openEnglish.textContent = 'Open English on Scryfall';
      openEnglish.onclick = function(){
        var url = card.prints_search_uri + '&unique=prints';
        fetch(url).then(function(res){ return res.json(); }).then(function(data){
          var english = null;
          if (data && data.data && data.data.length){
            for (var i=0; i<data.data.length; i++){
              if (data.data[i].lang === 'en'){ english = data.data[i]; break; }
            }
          }
          window.open((english && english.scryfall_uri) ? english.scryfall_uri : card.scryfall_uri, '_blank');
        }).catch(function(){
          window.open(card.scryfall_uri, '_blank');
        });
      };
      actionsEl.appendChild(openEnglish);
    }

    function renderSuggestions(list){
      altsEl.innerHTML = '';
      if (!list || !list.data || !list.data.length) return;
      var ul = document.createElement('ul');
      ul.className = 'suggestions';
      for (var i=0; i<Math.min(6, list.data.length); i++){
        (function(name){
          var li = document.createElement('li');
          var b = document.createElement('button');
          b.textContent = name;
          b.onclick = function(){
            guessInput.value = name;
            lookupByName(name);
          };
          li.appendChild(b);
          ul.appendChild(li);
        })(list.data[i]);
      }
      var wrap = document.createElement('div');
      wrap.innerHTML = '<p class="small">Did you mean:</p>';
      wrap.appendChild(ul);
      altsEl.appendChild(wrap);
    }

    function lookupByName(name){
      if (!name){ logStatus('Empty name.', false); return; }
      resultEl.innerHTML = '';
      actionsEl.innerHTML = '';
      altsEl.innerHTML = '';
      logStatus('Looking up "' + name + '"…', false);

      // Strategy chain
      scryfallNamedFuzzy(name).then(function(card){
        renderCard(card); logStatus('Found via named?fuzzy.', true);
      }).catch(function(){
        scryfallSearchLangAnyExactPhrase(name).then(function(card){
          renderCard(card); logStatus('Found via lang:any exact phrase.', true);
        }).catch(function(){
          scryfallSearchFrenchExactPhrase(name).then(function(card){
            renderCard(card); logStatus('Found via lang:fr exact phrase.', true);
          }).catch(function(){
            // Last resort: autocomplete suggestions
            var sanitized = sanitizeName(name);
            scryfallAutocomplete(sanitized).then(function(sug){
              logStatus('Couldn\'t find an exact match. Pick a suggestion.', false);
              renderSuggestions(sug);
            }).catch(function(err){
              logStatus('No results. Try editing the detected name.', false);
            });
          });
        });
      });
    }

    lookupBtn.addEventListener('click', function(){
      var v = (guessInput.value || '').trim();
      lookupByName(v);
    });

    scanBtn.addEventListener('click', function(){
      if (!currentStream){ logStatus('Start camera first.', false); return; }
      var w = video.videoWidth, h = video.videoHeight;
      if (!w || !h){ logStatus('Camera not ready yet.', false); return; }

      canvas.width = w; canvas.height = h;
      var ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, w, h);

      logStatus('Loading OCR…', false);
      if (Tesseract){ runOCR(); }
      else {
        var s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js';
        s.onload = function(){ Tesseract = window.Tesseract; runOCR(); };
        s.onerror = function(){ logStatus('Failed to load OCR library.', false); };
        document.head.appendChild(s);
      }

      function runOCR(){
        logStatus('Running OCR…', false);
        Tesseract.recognize(canvas, 'eng+fra', {}).then(function(res){
          var raw = (res && res.data && res.data.text) ? res.data.text : '';
          ocrTextEl.textContent = (raw || '').trim();
          var first = firstTextLine(raw);
          var guess = sanitizeName(first);
          if (!guess){ logStatus('No readable text found—move closer to the card title.', false); return; }
          guessInput.value = guess;
          lookupBtn.disabled = false;
          lookupByName(guess);
        }).catch(function(err){
          logStatus('OCR error: ' + (err && err.message ? err.message : err), false);
        });
      }
    });

    // Initial status
    if (!isSecureAllowed()) logStatus('HTTPS required for camera access.', false);
    else logStatus('Tap “Start Camera” to allow access.', false);
  </script>
</body>
</html>
