<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Le MTG Scanner</title>
  <style>
    body {
      font-family: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      margin: 16px;
      line-height: 1.45;
      background: #F4E4C1; /* Light yellow background */
    }
    header { margin-bottom: 12px; }
    .stage { position: relative; display: inline-block; }
    video, canvas { width: 100%; max-width: 680px; border: 1px solid #ddd; border-radius: 8px; }
    .roi { position: absolute; border: 2px dashed rgba(0,0,0,0.7); background: rgba(0,0,0,0.05);
           border-radius: 6px; pointer-events: none; }
    .handle { position: absolute; width: 16px; height: 16px; background: rgba(0,0,0,0.85); border-radius: 50%; pointer-events: auto; }
    .handle.br { right: -8px; bottom: -8px; cursor: nwse-resize; }
    button { padding: 10px 14px; border-radius: 8px; border: 1px solid #ccc; background: #f7f7f7; font-size: 16px; }
    button:disabled { opacity: 0.5; }
    #status { font-size: 14px; opacity: 0.9; display:inline-block; margin-top:8px; }
    #result img { max-width: 100%; border-radius: 8px; border: 1px solid #ddd; }
    #ocrText { white-space: pre-wrap; background: #fafafa; border: 1px solid #eee; padding: 8px; border-radius: 6px; }
    .small { font-size: 12px; color: #666; }
    .warn { color: #b00020; }
    .ok { color: #0a7f11; }
    .block { display:block; }
    .meta p { margin: 6px 0; }
    .badge { font-size: 12px; padding: 2px 6px; border: 1px solid #ddd; border-radius: 999px; }
    .row { display: flex; flex-wrap: wrap; gap: 16px; }
    .col { flex: 1 1 340px; min-width: 320px; }

    @media (orientation: landscape) {
      .row {
        flex-direction: row;
        align-items: flex-start;
      }

      .col {
        flex: 1 1 50%;
        min-width: 50%;
      }

      .stage {
        margin-right: 16px;
      }

      #result {
        margin-left: 16px;
      }
    }
  </style>
</head>
<body>
  <header style="display: flex; align-items: center; justify-content: center; gap: 16px;">
    <h1>Le MTG Scanner</h1>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 3 2" width="50" height="33" aria-label="French Flag">
      <rect width="1" height="2" x="0" fill="#0055A4" />
      <rect width="1" height="2" x="1" fill="#FFFFFF" />
      <rect width="1" height="2" x="2" fill="#EF4135" />
    </svg>
  </header>

  <div class="row">
    <div class="col">
      <div class="stage">
        <video id="video" playsinline muted></video>
        <div id="roi" class="roi">
          <div class="handle br" title="Drag to resize"></div>
        </div>
      </div>
      <div style="margin-top:8px;">
        <button id="startBtn">Start Camera</button>
        <button id="scanBtn" disabled>Scan Title &amp; Lookup</button>
      </div>
      <span id="status" class="block"></span>

      <!-- Search Field Moved Here -->
      <div style="margin-top: 16px;">
        <input id="manualSearchInput" type="text" placeholder="Type card name..." style="padding: 8px; width: calc(100% - 120px); border: 1px solid #ccc; border-radius: 4px;">
        <button id="manualSearchBtn" style="padding: 8px 16px; border-radius: 4px; border: 1px solid #ccc; background: #f7f7f7;">Search</button>
      </div>

      <canvas id="canvas" hidden></canvas>
    </div>

    <div class="col">
      <h3>Result</h3>
      <div id="result"></div>
      <div id="actions" style="margin-top:8px;"></div>
      <details style="margin-top:8px;">
        <summary>Show OCR text</summary>
        <pre id="ocrText"></pre>
      </details>
    </div>
  </div>

  <div id="storedLinks" style="margin-top: 24px;">
    <h3>Lookup Log</h3>
    <table id="linksTable" style="width: 100%; border-collapse: collapse;">
      <thead>
        <tr>
          <th style="text-align: left; padding: 8px; border-bottom: 1px solid #ddd; cursor: pointer;" data-sort="frenchName">French Name</th>
          <th style="text-align: left; padding: 8px; border-bottom: 1px solid #ddd; cursor: pointer;" data-sort="englishName">English Name</th>
          <th style="text-align: left; padding: 8px; border-bottom: 1px solid #ddd; cursor: pointer;" data-sort="totalMana">Total Mana</th>
          <th style="text-align: left; padding: 8px; border-bottom: 1px solid #ddd; cursor: pointer;" data-sort="specificMana">Specific Mana</th>
          <th style="text-align: left; padding: 8px; border-bottom: 1px solid #ddd;">Card Text</th>
          <th style="text-align: left; padding: 8px; border-bottom: 1px solid #ddd;">Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    var video = document.getElementById('video');
    var canvas = document.getElementById('canvas');
    var startBtn = document.getElementById('startBtn');
    var scanBtn = document.getElementById('scanBtn');
    var statusEl = document.getElementById('status');
    var resultEl = document.getElementById('result');
    var actionsEl = document.getElementById('actions');
    var ocrTextEl = document.getElementById('ocrText');
    var roi = document.getElementById('roi');

    var currentStream = null;
    var usingBackCamera = true;
    var Tesseract = null;

    function logStatus(msg, ok){
      statusEl.textContent = msg;
      statusEl.className = (ok ? 'ok' : 'warn') + ' block';
      console.log('[status]', msg);
    }
    function isSecureAllowed() {
      var loc = window.location;
      return loc.protocol === 'https:' || loc.hostname === 'localhost' || loc.hostname === '127.0.0.1';
    }
    function setDefaultROI(){
      var rect = video.getBoundingClientRect();
      var W = rect.width, H = rect.height;
      var left = Math.round(W * 0.08);
      var top  = Math.round(H * 0.07);
      var width = Math.round(W * 0.84);
      var height= Math.round(H * 0.14);
      roi.style.left = left + 'px';
      roi.style.top = top + 'px';
      roi.style.width = width + 'px';
      roi.style.height= height + 'px';
    }
    function startCamera(){
      if (!isSecureAllowed()) { logStatus('Camera requires HTTPS or localhost.', false); return; }
      if (!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia)) {
        logStatus('This browser does not support camera access (getUserMedia).', false); return;
      }
      var constraints = { audio:false, video:{ facingMode:{ ideal: usingBackCamera ? 'environment' : 'user' } } };
      navigator.mediaDevices.getUserMedia(constraints).then(function(stream){
        currentStream = stream; video.srcObject = stream; return video.play();
      }).then(function(){
        scanBtn.disabled = false; setDefaultROI(); logStatus('Camera started.', true);
      }).catch(function(e1){
        navigator.mediaDevices.getUserMedia({ video:true, audio:false }).then(function(stream){
          currentStream = stream; video.srcObject = stream; return video.play();
        }).then(function(){ scanBtn.disabled = false; setDefaultROI(); logStatus('Camera started (fallback).', true); })
        .catch(function(e2){ logStatus('Camera error: ' + (e2 && e2.message ? e2.message : e2), false); alert('Camera error: ' + (e2 && e2.message ? e2.message : e2)); });
      });
    }
    function stopCamera(){
      if (currentStream){ var tracks = currentStream.getTracks(); for (var i=0;i<tracks.length;i++) tracks[i].stop(); }
      currentStream = null; scanBtn.disabled = true; logStatus('Camera stopped.', false);
    }
    startBtn.addEventListener('click', function(){ if (currentStream) stopCamera(); else startCamera(); });
    // ROI resize only (overlay doesn't capture other taps)
    (function(){
      var dragging=false, startX=0,startY=0,startW=0,startH=0;
      var handle = roi.querySelector('.handle.br');
      roi.addEventListener('dblclick', function(){ setDefaultROI(); });
      handle.addEventListener('pointerdown', function(e){
        startX=e.clientX; startY=e.clientY;
        var r=roi.getBoundingClientRect(); startW=r.width; startH=r.height;
        handle.setPointerCapture(e.pointerId); dragging=true;
      });
      handle.addEventListener('pointermove', function(e){
        if (!dragging) return;
        var dx=e.clientX-startX, dy=e.clientY-startY;
        roi.style.width = Math.max(40, startW+dx) + 'px';
        roi.style.height= Math.max(24, startH+dy) + 'px';
      });
      handle.addEventListener('pointerup', function(e){ dragging=false; handle.releasePointerCapture(e.pointerId); });
    })();

    function loadTesseract(){
      if (Tesseract) return Promise.resolve(Tesseract);
      return new Promise(function(resolve, reject){
        var s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js';
        s.onload=function(){ Tesseract=window.Tesseract; resolve(Tesseract); };
        s.onerror=function(){ reject(new Error('Failed to load Tesseract.js')); };
        document.head.appendChild(s);
      });
    }
    function preprocessROI(ctx, sx, sy, sw, sh){
      var tmp=document.createElement('canvas'); tmp.width=sw; tmp.height=sh;
      var tctx=tmp.getContext('2d'); var imgData=ctx.getImageData(sx,sy,sw,sh); var d=imgData.data,i;
      for(i=0;i<d.length;i+=4){ var yv=0.299*d[i]+0.587*d[i+1]+0.114*d[i+2]; d[i]=d[i+1]=d[i+2]=yv; }
      var sum=0; for(i=0;i<d.length;i+=4){ sum+=d[i]; } var mean=sum/(d.length/4);
      for(i=0;i<d.length;i+=4){ var v=d[i]>mean?255:0; d[i]=d[i+1]=d[i+2]=v; }
      tctx.putImageData(imgData,0,0); return tmp;
    }
    function firstTextLine(raw){
      var lines=(raw||'').split(/[\r\n]+/); for(var i=0;i<lines.length;i++){ var l=(lines[i]||'').trim(); if(!l) continue;
        var letters=l.replace(/[^A-Za-zÀ-ÖØ-öø-ÿ'\-’ ]/g,''); if(letters.replace(/\s+/g,'').length>=Math.max(3, Math.floor(l.length*0.6))) return l; }
      return (lines[0]||'').trim();
    }
    function sanitizeName(s){ return (s||'').replace(/[0-9]+/g,' ').replace(/[^A-Za-zÀ-ÖØ-öø-ÿ'\-’ ]/g,' ').replace(/\s+/g,' ').trim(); }

    // Fast Scryfall path
    function scryfallNamedFuzzy(name){
      return fetch('https://api.scryfall.com/cards/named?fuzzy=' + encodeURIComponent(name))
        .then(function(res){ if(!res.ok) throw new Error('named?fuzzy ' + res.status); return res.json(); });
    }
    function scryfallEnglishByOracle(oracle_id){
      var q='oracleid:'+oracle_id+' lang:en';
      var url='https://api.scryfall.com/cards/search?q='+encodeURIComponent(q)+'&unique=prints';
      return fetch(url).then(function(r){ if(!r.ok) throw new Error('search oracleid '+r.status); return r.json(); });
    }
    function scryfallSearchLangAnyExact(name){
      var q='lang:any "'+name+'"';
      var url='https://api.scryfall.com/cards/search?q='+encodeURIComponent(q)+'&include_multilingual=true&unique=prints';
      return fetch(url).then(function(r){ if(!r.ok) throw new Error('search lang:any '+r.status); return r.json(); });
    }

    function pickEnglish(list){
      if (!(list && list.data && list.data.length)) return null;
      for (var i=0;i<list.data.length;i++){
        var c=list.data[i];
        if (c.lang==='en' && c.image_uris && c.image_uris.normal) return c;
      }
      for (var j=0;j<list.data.length;j++){
        var c2=list.data[j];
        if (c2.lang==='en') return c2;
      }
      return list.data[0];
    }

    function renderCard(card, label) {
  const img = (card.image_uris && card.image_uris.normal)
    ? card.image_uris.normal
    : (card.card_faces && card.card_faces[0] && card.card_faces[0].image_uris
      ? card.card_faces[0].image_uris.normal
      : null);

  const container = document.createElement('div');
  container.style.marginBottom = '10px';

  if (img) {
    const image = document.createElement('img');
    image.src = img;
    image.alt = card.name;
    container.appendChild(image);
  }

  const details = document.createElement('details');
  details.style.marginTop = '8px';

  const summary = document.createElement('summary');
  summary.textContent = label || 'Card Details';
  details.appendChild(summary);

  const meta = document.createElement('div');
  meta.className = 'meta';
  const oracle = (card.oracle_text || '').replace(/\n/g, '<br>');
  meta.innerHTML = `
    <p><strong>${card.name}</strong></p>
    <p>${card.type_line || ''}</p>
    <p><em>Oracle Text:</em><br>${oracle}</p>
  `;
  details.appendChild(meta);

  container.appendChild(details);
  return container;
}

    function showResults(anyCard, enCard, ocrGuess) {
      resultEl.innerHTML = '';
      actionsEl.innerHTML = '';

      if (enCard) resultEl.appendChild(renderCard(enCard, 'English'));

      if (anyCard && (!enCard || anyCard.lang !== 'en')) {
        const details = document.createElement('details');
        details.style.marginTop = '8px';

        const summary = document.createElement('summary');
        summary.textContent = 'Show French Card';
        details.appendChild(summary);

        const frenchCard = renderCard(anyCard, 'Scanned printing (' + (anyCard.lang || '') + ')');
        details.appendChild(frenchCard);

        resultEl.appendChild(details);
      }

      if (enCard) {
        // Automatically log the lookup with Oracle text, card type, mana cost, and colors
        storeLink(
          ocrGuess,
          enCard.name,
          enCard.scryfall_uri,
          enCard.oracle_text,
          enCard.type_line,
          enCard.mana_cost,
          enCard.colors // Pass the colors array
        );
      }
    }

    function pipelineFast(name) {
      resultEl.innerHTML = '';
      actionsEl.innerHTML = '';
      logStatus('Fast lookup (fuzzy) for "' + name + '"...', false);
      scryfallNamedFuzzy(name).then(function (card) {
        logStatus('Got fuzzy match (' + (card.lang || '?') + '). Fetching English by oracle_id…', false);
        return scryfallEnglishByOracle(card.oracle_id).then(function (enList) {
          var enCard = pickEnglish(enList);
          showResults(card, enCard, name); // Pass the OCR guess (name)
          logStatus(enCard ? 'Done (English found).' : 'Done (no EN found; showing fuzzy printing).', !!enCard);
        });
      }).catch(function () {
        // Fallback: multilingual exact phrase (slower)
        logStatus('Fuzzy failed; trying multilingual exact search…', false);
        scryfallSearchLangAnyExact(name).then(function (list) {
          if (!(list && list.data && list.data.length)) throw new Error('No multilingual results.');
          var anyCard = list.data[0];
          return scryfallEnglishByOracle(anyCard.oracle_id).then(function (enList) {
            var enCard = pickEnglish(enList);
            showResults(anyCard, enCard, name); // Pass the OCR guess (name)
            logStatus(enCard ? 'Done (English via fallback).' : 'Done (fallback but no EN found).', !!enCard);
          });
        }).catch(function (err) {
          logStatus('Lookup failed. Try adjusting ROI or editing the name.', false);
        });
      });
    }

    document.getElementById('scanBtn').addEventListener('click', function(){
      if (!currentStream){ logStatus('Start camera first.', false); return; }
      var w=video.videoWidth, h=video.videoHeight; if (!w||!h){ logStatus('Camera not ready yet.', false); return; }
      canvas.width=w; canvas.height=h; var ctx=canvas.getContext('2d'); ctx.drawImage(video,0,0,w,h);
      var vb=video.getBoundingClientRect(); var rb=roi.getBoundingClientRect();
      var sx=Math.max(0, Math.round((rb.left - vb.left) * (w / vb.width)));
      var sy=Math.max(0, Math.round((rb.top  - vb.top ) * (h / vb.height)));
      var sw=Math.max(1, Math.round(rb.width  * (w / vb.width)));
      var sh=Math.max(1, Math.round(rb.height * (h / vb.height)));
      var processed=(function(){ var tmp=document.createElement('canvas'); tmp.width=sw; tmp.height=sh;
        var tctx=tmp.getContext('2d'); var imgData=ctx.getImageData(sx,sy,sw,sh); var d=imgData.data,i;
        for(i=0;i<d.length;i+=4){ var yv=0.299*d[i]+0.587*d[i+1]+0.114*d[i+2]; d[i]=d[i+1]=d[i+2]=yv; }
        var sum=0; for(i=0;i<d.length;i+=4){ sum+=d[i]; } var mean=sum/(d.length/4);
        for(i=0;i<d.length;i+=4){ var v=d[i]>mean?255:0; d[i]=d[i+1]=d[i+2]=v; }
        tctx.putImageData(imgData,0,0); return tmp; })();
      logStatus('Loading OCR…', false);
      if (Tesseract){ runOCR(); } else { var s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js';
        s.onload=function(){ Tesseract=window.Tesseract; runOCR(); }; s.onerror=function(){ logStatus('Failed to load OCR library.', false); };
        document.head.appendChild(s); }
      function runOCR() {
  logStatus('Running OCR…', false);
  Tesseract.recognize(processed, 'eng+fra', {}).then(function (res) {
    var raw = (res && res.data && res.data.text) ? res.data.text : '';
    ocrTextEl.textContent = (raw || '').trim();
    var first = (function () {
      var lines = (raw || '').split(/[\r\n]+/);
      for (var i = 0; i < lines.length; i++) {
        var l = (lines[i] || '').trim();
        if (!l) continue;
        var letters = l.replace(/[^A-Za-zÀ-ÖØ-öø-ÿ'\-’ ]/g, '');
        if (letters.replace(/\s+/g, '').length >= Math.max(3, Math.floor(l.length * 0.6))) return l;
      }
      return (lines[0] || '').trim();
    })();
    var guess = (first || '').replace(/[0-9]+/g, ' ').replace(/[^A-Za-zÀ-ÖØ-öø-ÿ'\-’ ]/g, ' ').replace(/\s+/g, ' ').trim();
    if (!guess) {
      logStatus('No readable title—adjust the box and try again.', false);
      return;
    }

    // Autofill the search field with the OCR result
    document.getElementById('manualSearchInput').value = guess;

    pipelineFast(guess);
  }).catch(function (err) {
    logStatus('OCR error: ' + (err && err.message ? err.message : err), false);
  });
}
    });

    function storeLink(frenchName, englishName, englishLink, oracleText, cardType, manaCost, colors, oracleId) {
  const linksTable = document.getElementById('linksTable').querySelector('tbody');
  const row = document.createElement('tr');

  // French Name Column
  const frenchCell = document.createElement('td');
  frenchCell.textContent = frenchName;
  frenchCell.dataset.sortValue = frenchName.toLowerCase(); // For sorting
  frenchCell.style.padding = '8px';
  row.appendChild(frenchCell);

  // English Name Column
  const englishCell = document.createElement('td');
  const link = document.createElement('a');
  link.href = englishLink;
  link.textContent = englishName;
  link.target = '_blank';
  link.rel = 'noopener';
  englishCell.appendChild(link);
  englishCell.dataset.sortValue = englishName.toLowerCase(); // For sorting
  englishCell.style.padding = '8px';
  row.appendChild(englishCell);

  // Total Mana Cost Column
  const totalManaCell = document.createElement('td');
  const totalMana = manaCost
    ? manaCost
        .match(/\{[^\}]+\}/g) // Match all mana symbols (e.g., {1}, {W}, {G})
        .reduce((sum, symbol) => {
          const numericValue = parseInt(symbol.replace(/\D/g, ''), 10); // Extract numeric value
          return sum + (isNaN(numericValue) ? 1 : numericValue); // Add 1 for symbolic mana (e.g., {W}, {G})
        }, 0)
    : 0;

  totalManaCell.textContent = totalMana || '0';
  totalManaCell.dataset.sortValue = totalMana; // For sorting
  totalManaCell.style.padding = '8px';
  row.appendChild(totalManaCell);

  // Specific Mana Cost Column
  const specificManaCell = document.createElement('td');
  specificManaCell.textContent = manaCost || 'Unknown';
  specificManaCell.dataset.sortValue = manaCost || ''; // For sorting

  // Set background color based on card colors
  if (colors && colors.length > 0) {
    const colorMap = {
      W: '#FFFACD', // White
      U: '#ADD8E6', // Blue
      B: '#D3D3D3', // Black
      R: '#FFA07A', // Red
      G: '#98FB98', // Green
    };

    // Map colors to their corresponding hex values
    const colorBackgrounds = colors.map((color) => colorMap[color] || '#FFFFFF'); // Default to white for unknown colors

    // Create a linear gradient for multicolored cards
    if (colorBackgrounds.length > 1) {
      specificManaCell.style.background = `linear-gradient(to right, ${colorBackgrounds.join(', ')})`;
    } else {
      specificManaCell.style.background = colorBackgrounds[0]; // Single color
    }
  } else {
    // Colorless: Match the page background
    specificManaCell.style.background = '#f4e4c1'; // Page background color
  }

  specificManaCell.style.padding = '8px';
  row.appendChild(specificManaCell);

  // Card Text Column (as a button)
  const textCell = document.createElement('td');
  const textButton = document.createElement('button');
  textButton.textContent = 'Show Text';
  textButton.style.padding = '6px 12px';
  textButton.style.border = '1px solid #ccc';
  textButton.style.borderRadius = '4px';
  textButton.style.background = '#f7f7f7';
  textButton.onclick = function () {
    if (oracleText && cardType) {
      alert(
        `Card Title: ${englishName}\nCard Type: ${cardType}\n\nOracle Text:\n${oracleText}`
      );
    } else if (oracleId) {
      fetchCardDetailsByOracleId(oracleId).then((details) => {
        alert(
          `Card Title: ${englishName}\nCard Type: ${details.cardType}\n\nOracle Text:\n${details.oracleText}`
        );
      });
    } else {
      alert('No card details available.');
    }
  };
  textCell.appendChild(textButton);
  textCell.style.padding = '8px';
  row.appendChild(textCell);

  // Actions Column (Remove Button)
  const actionsCell = document.createElement('td');
  const removeBtn = document.createElement('button');
  removeBtn.textContent = 'Remove';
  removeBtn.style.padding = '6px 12px';
  removeBtn.style.border = '1px solid #ccc';
  removeBtn.style.borderRadius = '4px';
  removeBtn.style.background = '#f7f7f7';
  removeBtn.onclick = function () {
    linksTable.removeChild(row);
  };
  actionsCell.appendChild(removeBtn);
  actionsCell.style.padding = '8px';
  row.appendChild(actionsCell);

  // Append the row to the table
  linksTable.appendChild(row);
}

    function saveLogToLocalStorage() {
  const rows = Array.from(document.querySelectorAll('#linksTable tbody tr'));
  const log = rows.map((row) => {
    const cells = row.querySelectorAll('td');
    return {
      frenchName: cells[0].textContent,
      englishName: cells[1].textContent,
      englishLink: cells[1].querySelector('a').href,
      totalMana: cells[2].textContent,
      specificMana: cells[3].textContent,
    };
  });
  localStorage.setItem('lookupLog', JSON.stringify(log));
}

    function loadLogFromLocalStorage() {
  const log = JSON.parse(localStorage.getItem('lookupLog') || '[]');
  log.forEach((entry) => {
    storeLink(
      entry.frenchName,
      entry.englishName,
      entry.englishLink,
      '', // Oracle text is not stored
      '', // Card type is not stored
      entry.specificMana,
      [] // Colors are not stored
    );
  });
}

    document.querySelectorAll('#linksTable thead th[data-sort]').forEach((header) => {
  header.addEventListener('click', function () {
    const sortKey = this.getAttribute('data-sort');
    const tableBody = document.querySelector('#linksTable tbody');
    const rows = Array.from(tableBody.querySelectorAll('tr'));

    // Determine sort direction
    const isAscending = this.dataset.sortDirection !== 'asc';
    this.dataset.sortDirection = isAscending ? 'asc' : 'desc';

    // Sort rows
    rows.sort((a, b) => {
      const aValue = a.querySelector(`td:nth-child(${this.cellIndex + 1})`).dataset.sortValue || '';
      const bValue = b.querySelector(`td:nth-child(${this.cellIndex + 1})`).dataset.sortValue || '';

      if (isAscending) {
        return aValue.localeCompare(bValue, undefined, { numeric: true });
      } else {
        return bValue.localeCompare(aValue, undefined, { numeric: true });
      }
    });

    // Re-append rows in sorted order
    rows.forEach((row) => tableBody.appendChild(row));
  });
});
    if (!isSecureAllowed()) logStatus('HTTPS required for camera access.', false);
    else logStatus('Tap “Start Camera”, then align the box and scan.', false);

    document.getElementById('manualSearchBtn').addEventListener('click', function () {
  const manualInput = document.getElementById('manualSearchInput').value.trim();
  if (!manualInput) {
    logStatus('Please enter a card name to search.', false);
    return;
  }
  logStatus(`Searching for "${manualInput}"...`, false);
  pipelineFast(manualInput); // Use the manual input for the search
});

    document.addEventListener('DOMContentLoaded', loadLogFromLocalStorage);

    function fetchCardDetailsByOracleId(oracleId) {
  const url = `https://api.scryfall.com/cards/search?q=oracleid:${oracleId}`;
  return fetch(url)
    .then((response) => {
      if (!response.ok) throw new Error('Failed to fetch card details.');
      return response.json();
    })
    .then((data) => {
      if (data && data.data && data.data.length > 0) {
        const card = data.data[0];
        return {
          oracleText: card.oracle_text || 'No Oracle text available.',
          cardType: card.type_line || 'No card type available.',
        };
      } else {
        throw new Error('No card details found.');
      }
    });
}
  </script>
</body>
</html>
